# üöÄ –¢–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ ETL-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É: Airflow + XCom + –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π DAG

## üìå –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å DAG –≤ Apache Airflow, –∫–æ—Ç–æ—Ä—ã–π:

- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —á–∏—Å–ª–æ `N` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `10`);
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `N` –∑–∞–¥–∞—á;
- –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ —Å—á–∏—Ç–∞–µ—Ç –∫–≤–∞–¥—Ä–∞—Ç —á–∏—Å–ª–∞: `i * i` –¥–ª—è `i = 1..N`;
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ **XCom**;
- –§–∏–Ω–∞–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞ –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∏ –ø–µ—á–∞—Ç–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

---


==============================
–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞: Airflow ETL
==============================

üì¶ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
-------------
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Docker
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Docker Compose
- –ù–µ –º–µ–Ω–µ–µ 2 –ì–ë –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É

üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:
---------------------
airflow-etl/
‚îú‚îÄ‚îÄ dags/
‚îÇ   ‚îî‚îÄ‚îÄ dynamic_square_dag.py
‚îú‚îÄ‚îÄ plugins/
‚îú‚îÄ‚îÄ logs/
‚îú‚îÄ‚îÄ docker-compose.yaml
‚îî‚îÄ‚îÄ deployment_instructions.txt


üöÄ –®–∞–≥ 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∏ Compose
-----------------------------------

üîπ Linux (Ubuntu):

    sudo apt update
    sudo apt install -y docker.io docker-compose
    sudo usermod -aG docker $USER
    newgrp docker

üîπ macOS / Windows:

    - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker Desktop: https://www.docker.com/products/docker-desktop

    - –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).

üîπ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

    docker --version
    docker compose version


üöÄ –®–∞–≥ 2. –ó–∞–ø—É—Å–∫ Airflow
------------------------

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞:

    cd airflow-etl_test

2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Airflow –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

    docker compose up airflow-init

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ —Ñ–æ–Ω–µ:

    docker compose up -d


üåê –®–∞–≥ 3. –í—Ö–æ–¥ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Airflow
---------------------------------

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞:

    http://localhost:8080

2. –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å:

    –õ–æ–≥–∏–Ω: admin
    –ü–∞—Ä–æ–ª—å: admin


üõ†Ô∏è –®–∞–≥ 4. –ó–∞–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π N
------------------------------

1. –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Airflow:
    
    –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é square_dag_n

üîÅ –í—ã –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å –ª—é–±–æ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ > 0


üìù –®–∞–≥ 4.5. –°–æ–∑–¥–∞–Ω–∏–µ DAG-—Ñ–∞–π–ª–∞ –∏ –¥–µ–ø–ª–æ–π
--------------------------------------

1. –í –∫–∞—Ç–∞–ª–æ–≥–µ `airflow-etl_test/` —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥ `dags`, –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç:

    mkdir -p dags

2. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª:

    dags/dynamic_square_dag.py (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å–≤—É–µ—Ç –≤ –ø—Ä–æ–µ–∫—Ç–µ)

3. –ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–¥


4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Airflow, —á—Ç–æ–±—ã DAG –ø–æ–¥—Ö–≤–∞—Ç–∏–ª—Å—è:

    docker compose restart


‚ñ∂Ô∏è –®–∞–≥ 5. –ó–∞–ø—É—Å–∫ DAG
---------------------

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "DAGs"
2. –ù–∞–π–¥–∏—Ç–µ `dynamic_square_dag`
3. –í–∫–ª—é—á–∏—Ç–µ DAG (—Ç—É–º–±–ª–µ—Ä)
4. –ù–∞–∂–º–∏—Ç–µ ‚ñ∂ (Trigger DAG) –¥–ª—è –∑–∞–ø—É—Å–∫–∞


üîé –®–∞–≥ 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
----------------------------

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É "Graph View"
2. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∑–∞–¥–∞—á—É `aggregate_results`
3. –û—Ç–∫—Ä–æ–π—Ç–µ Logs ‚Üí –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å: —Ä–µ–∑—É–ª—å—Ç–∞—Ç

   


üßπ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞
------------------------------------

–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã:

    docker compose down

–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ:

    docker volume rm airflow-etl_postgres-db-volume

–ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫:

    docker compose up airflow-init
    docker compose up -d


üìå –ü–æ–¥—Å–∫–∞–∑–∫–∏
------------

- –ï—Å–ª–∏ –ø–æ—Ä—Ç 8080 –∑–∞–Ω—è—Ç ‚Üí –æ—Ç–∫—Ä–æ–π—Ç–µ `docker-compose.yaml` –∏ –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ `8081:8080`
- –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Docker ‚Üí –¥–æ–±–∞–≤—å—Ç–µ —Å–µ–±—è –≤ –≥—Ä—É–ø–ø—É `docker` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª
- –ù–µ –≤–∏–¥–µ–Ω DAG? –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `dynamic_square_dag.py` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `dags/`

